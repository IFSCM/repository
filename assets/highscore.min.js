const gameVersion="6.1",relay="https://varied-peggi-coredigital-47cb7fd7.koyeb.app/relay?link=",scoreEndpoint="http://ec2-3-8-192-132.eu-west-2.compute.amazonaws.com:4040",restrictAll=!1,relayedEndpoint="https://varied-peggi-coredigital-47cb7fd7.koyeb.app/relay?link=http://ec2-3-8-192-132.eu-west-2.compute.amazonaws.com:4040";async function populateHS(){fetch(relayedEndpoint+"/players/highscores").then(e=>e.json()).then(e=>{let t=document.querySelectorAll(".highscore-list");t.forEach(t=>{if(t.innerHTML="",0===e.length){let r=document.createElement("div");r.classList.add("no-highscore"),r.textContent="Much empty",t.appendChild(r);return}e.forEach(e=>{let[r,o,n]=e,i=document.createElement("div");i.classList.add("highscore-row");let a=document.createElement("div");a.classList.add("gamerank"),a.textContent=r;let s=document.createElement("div");s.classList.add("gameusername");let c=document.createElement("a");c.href=`https://twitter.com/${o}`,c.textContent=o,c.target="_blank",s.appendChild(c);let l=document.createElement("div");l.classList.add("gamescore"),l.textContent=n,i.appendChild(a),i.appendChild(s),i.appendChild(l),t.appendChild(i)})})}).catch(e=>{console.error("Error fetching highscores:",e)})}async function getIPAddress(){try{let e=await fetch("https://ipinfo.io/json");if(!e.ok)throw Error("Network response was not ok");let t=await e.json();return sessionStorage.setItem("twitter_user_ip",t.ip),t.ip}catch(r){throw console.error("Error fetching IP:",r),showToast("Toast oombi"),r}}async function newTwitterToken(e){try{let t=new URLSearchParams;t.append("code",e),t.append("code_verifier",sessionStorage.getItem("twitter_code_verifier"));let r=t.toString(),o=`${relayedEndpoint}/twitter/get_token?${r}`,n=await fetch(o);if(!n.ok)throw Error("Network response was not ok");let i=await n.json(),a=Math.floor(Date.now()/1e3);localStorage.setItem("nextUpdate",a),localStorage.setItem("twitter_token",i.access_token),localStorage.setItem("twitter_refresh",i.refresh_token),sessionStorage.setItem("isLoggedIn","true"),sessionStorage.removeItem("attempt"),await checkToken(i.access_token)}catch(s){return console.error("Error fetching data:",s),null}}async function newRefreshToken(e){let t=new URLSearchParams;t.append("refresh_token",e);let r=t.toString(),o=`${relayedEndpoint}/twitter/refresh_token?${r}`;await fetch(o).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{let t=Math.floor(Date.now()/1e3);return localStorage.setItem("nextUpdate",t),localStorage.setItem("twitter_token",e.access_token),localStorage.setItem("twitter_refresh",e.refresh_token),sessionStorage.setItem("isLoggedIn","true"),sessionStorage.removeItem("attempt"),!0}).catch(e=>(console.error("Error fetching data:",e),null))}async function uploadMedia(e,t,r){let o=new URLSearchParams;o.append("id",e),o.append("url",t),o.append("points",r);let n=o.toString(),i=`${relayedEndpoint}/twitter/upload_media?${n}`;await fetch(i).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{sessionStorage.setItem("twitter_media_id",e.id)}).catch(e=>(console.error("Error fetching data:",e),null))}async function postMedia(e,t,r){try{let o=new URLSearchParams;o.append("text",encodeURIComponent(e)),o.append("media_id",t),o.append("token",r);let n=o.toString(),i=`${relayedEndpoint}/twitter/post_tweet?${n}`,a=await fetch(i);if(a.ok){let s=await a.json();s&&s.data&&(showToast("Tweeted Highscore!"),await accountPoints(sessionStorage.getItem("twitter_score")),await populateHS(),console.log("Tweet ID:",s.data.id),console.log("Tweet Text:",s.data.text))}else{if(localStorage.getItem("twitter_token"))return!1;throw localStorage.removeItem("twitter_token"),localStorage.removeItem("twitter_refresh"),localStorage.removeItem("twitter_pic"),localStorage.removeItem("twitter_username"),localStorage.removeItem("twitter_code_challenger"),localStorage.removeItem("twitter_code_verifier"),sessionStorage.removeItem("attempt"),showToast("Error posting media. Removing login session. Please try again."),window.location.href="/",Error("Network response was not ok")}}catch(c){return console.error("Error fetching data:",c),localStorage.removeItem("twitter_token"),localStorage.removeItem("twitter_refresh"),localStorage.removeItem("twitter_pic"),localStorage.removeItem("twitter_username"),localStorage.removeItem("twitter_code_challenger"),localStorage.removeItem("twitter_code_verifier"),showToast("Error posting media. Removing login session. Please try again."),window.location.href="/",null}}async function checkToken(e){let t=new URLSearchParams;t.append("token",e);let r=t.toString();console.log("Checking Token:",e);let o=`${relayedEndpoint}/twitter/user_info?${r}`;await fetch(o).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(t=>(console.log(t),t.username&&t.profile_image_url)?(localStorage.setItem("twitter_username",t.username),localStorage.setItem("twitter_pic",t.profile_image_url),console.log("Token Verified: ",e),sessionStorage.setItem("isLoggedIn","true"),!0):(sessionStorage.setItem("isLoggedIn","false"),null)).catch(e=>{console.error("Error fetching data:",e)})}async function revokeAccessToken(e){let t=new URLSearchParams;t.append("token",e);let r=t.toString(),o=`${relayedEndpoint}/twitter/revoke_token?${r}`;await fetch(o).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{e&&!0===e.revoked&&console.log("Revoked Token Access:",e)}).catch(e=>(console.error("Error fetching data:",e),null))}async function tryLogin(){let e=localStorage.getItem("twitter_username"),t=localStorage.getItem("twitter_pic");if(e&&t){sessionStorage.setItem("isLoggedIn","true");var r=document.getElementById("login-button");if(r){console.error("Login button found");var o=document.createElement("a");o.href="#",o.innerHTML='<img src="'+t+'" alt="Twitter Profile Picture" class="twitter-profile-pic">',r.parentNode.replaceChild(o,r),o.querySelector(".twitter-profile-pic").addEventListener("click",function(e){e.preventDefault();var t=document.getElementById("logout-dropdown");t.style.display="block"===t.style.display?"none":"block"}),console.error("Login success")}else console.error("Login button element not found in the DOM.")}}async function initiateLogout(){await revokeAccessToken(localStorage.getItem("twitter_token")),localStorage.removeItem("twitter_token"),localStorage.removeItem("twitter_refresh"),localStorage.removeItem("twitter_pic"),localStorage.removeItem("twitter_username"),localStorage.removeItem("twitter_code_challenger"),localStorage.removeItem("twitter_code_verifier"),showToast("Logged out successfully"),window.location.href="/"}async function constructAuthURL(e){if("post"===e&&"trues"===sessionStorage.getItem("isLoggedIn"))await postSequence();else try{let t=await fetch(relayedEndpoint+"/twitter/code_auth");if(!t.ok)throw Error("Network response was not ok");let r=await t.json(),o=r.link,n=new Date().toString();sessionStorage.setItem("dateTime",n),sessionStorage.setItem("twitter_state",e+r.state),sessionStorage.setItem("twitter_code_challenge",r.code_challenge),sessionStorage.setItem("twitter_code_verifier",r.code_verifier),console.log(o),window.location.href=o}catch(i){showToast("Failed to construct OAuth2.0"),console.error("Error fetching data:",i)}}function showToast(e){var t=document.createElement("div");t.classList.add("toast"),t.innerHTML=`
    <span class="toast-message">${e}</span>
    <span class="toast-close">&times;</span>
  `;var r=document.querySelector(".toast-container");r.appendChild(t),setTimeout(function(){r.contains(t)&&r.removeChild(t)},5e3),t.querySelector(".toast-close").addEventListener("click",function(){r.contains(t)&&r.removeChild(t)})}async function initHSButton(){var e,t=document.querySelectorAll("#share-score-button");for(let r of t){if("0"===document.querySelector("#share-score").innerText.trim())r.disabled=!0,r.style.opacity="0.5",r.style.cursor="not-allowed";else try{await fetchHighestScore(),r.disabled=!1,r.style.opacity="1",r.style.cursor="pointer"}catch(o){console.error("Error fetching highest score:",o)}}}async function fetchHighestScore(){try{let e=await fetch(relayedEndpoint+"/players/highscores"),t=await e.text(),r=JSON.parse(t);if(0===r.length)return 0;return console.log(r[0][1]),r[0][2]}catch(o){return console.error("Error fetching highest score:",o),null}}async function accountPoints(e){let t=new URLSearchParams;t.append("ip",sessionStorage.getItem("twitter_user_ip")),t.append("score",e),localStorage.getItem("twitter_username")&&t.append("twitter",localStorage.getItem("twitter_username"));let r=t.toString(),o=`${relayedEndpoint}/players/add?${r}`;await fetch(o).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(t=>{sessionStorage.setItem("twitter_score",e)}).catch(e=>{console.error("Error fetching data:",e)})}async function logScore(){var e=document.querySelector("#gamedisplay > div.score"),t=document.querySelectorAll("#share-score");if(e){var r=e.innerText.split(":")[1].trim();t.forEach(function(e){e.innerText=r}),await initHSButton(),sessionStorage.setItem("twitter_score",r),await populateHS()}else console.log("Score element not found.")}async function getEndpoint(){var e=window.location.pathname;if("/callback"===e){let t=new URLSearchParams(window.location.search),r=t.get("state"),o=sessionStorage.getItem("twitter_state"),n=t.get("code");console.log("Twitter State:",r),console.log("Local Twitter State:",o),console.log("Twitter Code:",n),o.includes(r)?(await newTwitterToken(n),await tryLogin(),o.includes("post")&&(console.log("Ready to Post"),await postSequence())):showToast("Error. Invalid State.")}else"/version"===e&&showToast("Game Version:6.1"),sessionStorage.removeItem("twitter_score")}async function postSequence(){var e=localStorage.getItem("twitter_username"),t=localStorage.getItem("twitter_pic"),r=sessionStorage.getItem("twitter_score");await uploadMedia(e,t,r),showToast("Posting... "),await postMedia("I JUST SCORED "+r+" POINTS on @Base_Invader! BaseInvaders is beyond BASED. Will this net me some $BINV tokens? #BaseInvaders",sessionStorage.getItem("twitter_media_id"),localStorage.getItem("twitter_token"))}async function routineProcedure(){sessionStorage.setItem("baseinvader_version","6.1"),await getIPAddress(),await tryLogin(),await initHSButton(),await populateHS(),await getEndpoint()}function updateLinks(e,t){let r=document.getElementById("gitbook-link"),o=document.getElementById("uniswap-link");r?r.href=e:console.log("No Gitbook"),o?o.href=t:console.log("No UniSwap")}var observerConfig={childList:!0,subtree:!0},callback=function(e,t){for(var r of e)if("childList"===r.type&&r.addedNodes&&r.addedNodes.length)for(var o=0;o<r.addedNodes.length;o++){var n=r.addedNodes[o];if("BIG"===n.nodeName&&"Game Over"===n.textContent.trim()){logScore();return}}},observer=new MutationObserver(callback);document.addEventListener("DOMContentLoaded",function(){observer.observe(document.body,observerConfig)}),routineProcedure();
