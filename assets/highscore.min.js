const gameVersion="6.91",relay="https://varied-peggi-coredigital-47cb7fd7.koyeb.app/relay?link=",scoreEndpoint="http://ec2-13-42-34-67.eu-west-2.compute.amazonaws.com:4040",restrictAll=!1,relayedEndpoint="https://varied-peggi-coredigital-47cb7fd7.koyeb.app/relay?link=http://ec2-13-42-34-67.eu-west-2.compute.amazonaws.com:4040",postEndpoint="https://xpost.xet3mirror.workers.dev",gblink="https://docs.baseinvaders.xyz",unilink="https://app.uniswap.org/swap?outputCurrency=&chain=base";async function populateHS(){fetch(relayedEndpoint+"/players/highscores").then(e=>e.json()).then(e=>{let t=document.querySelectorAll(".highscore-list");t.forEach(t=>{if(t.innerHTML="",0===e.length){let o=document.createElement("div");o.classList.add("no-highscore"),o.textContent="Much empty",t.appendChild(o);return}e.forEach(e=>{let[o,r,n]=e,a=document.createElement("div");a.classList.add("highscore-row");let i=document.createElement("div");i.classList.add("gamerank"),i.textContent=o;let s=document.createElement("div");s.classList.add("gameusername");let c=document.createElement("a");c.href=`https://twitter.com/${r}`,c.textContent=r,c.target="_blank",s.appendChild(c);let l=document.createElement("div");l.classList.add("gamescore"),l.textContent=n,a.appendChild(i),a.appendChild(s),a.appendChild(l),t.appendChild(a)})})}).catch(e=>{console.error("Error fetching highscores:",e)})}async function getIPAddress(){try{let e=await fetch("https://ipinfo.io/json");if(!e.ok)throw Error("Network response was not ok");let t=await e.json();return sessionStorage.setItem("twitter_user_ip",t.ip),t.ip}catch(o){throw console.error("Error fetching IP:",o),showToast("Toast oombi"),o}}async function newTwitterToken(e){try{let t=new URLSearchParams;t.append("code",e),t.append("code_verifier",sessionStorage.getItem("twitter_code_verifier"));let o=t.toString(),r=`${relayedEndpoint}/twitter/get_token?${o}`,n=await fetch(r);if(!n.ok)throw Error("Network response was not ok");let a=await n.json(),i=Math.floor(Date.now()/1e3);localStorage.setItem("nextUpdate",i),localStorage.setItem("twitter_token",a.access_token),localStorage.setItem("twitter_refresh",a.refresh_token),sessionStorage.setItem("isLoggedIn","true"),sessionStorage.removeItem("attempt"),await checkToken(a.access_token)}catch(s){return console.error("Error fetching data:",s),null}}async function newRefreshToken(e){let t=new URLSearchParams;t.append("refresh_token",e);let o=t.toString(),r=`${relayedEndpoint}/twitter/refresh_token?${o}`;await fetch(r).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{let t=Math.floor(Date.now()/1e3);return localStorage.setItem("nextUpdate",t),localStorage.setItem("twitter_token",e.access_token),localStorage.setItem("twitter_refresh",e.refresh_token),sessionStorage.setItem("isLoggedIn","true"),sessionStorage.removeItem("attempt"),!0}).catch(e=>(console.error("Error fetching data:",e),null))}async function obtainRefreshToken(){let e=localStorage.getItem("twitter_refresh"),t=localStorage.getItem("nextUpdate");if(e&&!1===isValid(t)){let o=new URLSearchParams;o.append("refresh_token",e);let r=o.toString(),n=`${relayedEndpoint}/twitter/refresh_token?${r}`;try{let a=await fetch(n);if(!a.ok)throw Error("Network response was not ok");let i=await a.json(),s=Math.floor(Date.now()/1e3);return localStorage.setItem("nextUpdate",s),localStorage.setItem("twitter_token",i.access_token),localStorage.setItem("twitter_refresh",i.refresh_token),sessionStorage.setItem("isLoggedIn","true"),sessionStorage.removeItem("attempt"),await checkToken(i.access_token),!0}catch(c){return console.error("Error fetching data:",c),showToast("Session expired. Logging out."),await initiateLogout(),null}}}function isValid(e){if(!e)return!1;let t=Math.floor(Date.now()/1e3);return 6480>=Math.abs(t-e)}async function uploadMedia(e,t,o){let r=new URLSearchParams;r.append("accid",localStorage.getItem("twitter_id")),r.append("id",e),r.append("url",t),r.append("points",o);let n=r.toString(),a=`${relayedEndpoint}/twitter/upload_media?${n}`;await fetch(a).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{sessionStorage.setItem("twitter_media_id",e.id)}).catch(e=>(console.error("Error fetching data:",e),null))}async function postMedia(e,t,o){try{let r=new URLSearchParams;r.append("text",encodeURIComponent(e)),r.append("media_id",t),r.append("token",o);let n=r.toString(),a=`${relayedEndpoint}/twitter/post_tweet?${n}`,i=await fetch(a);if(i.ok){let s=await i.json();s&&s.data&&(showToast("Tweeted Highscore!"),await accountPoints(sessionStorage.getItem("twitter_score")),await populateHS(),console.log("Tweet ID:",s.data.id),console.log("Tweet Text:",s.data.text))}else if(localStorage.getItem("twitter_token"))throw localStorage.clear(),sessionStorage.clear(),showToast("Error posting media. Removing login session. Please try again."),window.location.href="/",Error("Network response was not ok")}catch(c){return console.error("Error fetching data:",c),localStorage.clear(),sessionStorage.clear(),showToast("Error posting media. Removing login session. Please try again."),window.location.href="/",null}}async function postTwitterMedia(e,t,o){if(!e||!t||!o)return Promise.reject({error:"Missing parameters"});try{let r=await fetch("https://api.twitter.com/2/tweets",{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"},body:JSON.stringify({text:e,media:{media_ids:[t]}})});if(r.ok){let n=await r.json();n&&n.data&&(showToast("Tweeted Highscore!"),await accountPoints(sessionStorage.getItem("twitter_score")),await populateHS(),console.log("Tweet ID:",n.data.id),console.log("Tweet Text:",n.data.text))}else if(429===r.status){let a=r.headers.get("x-rate-limit-reset"),i=resetHeader?parseInt(resetHeader)-Math.floor(Date.now()/1e3):15;console.log("429 Rate Limit:",a),console.log("Rate limit exceeded. Please wait "+i+"seconds before retrying.")}else throw localStorage.clear(),sessionStorage.clear(),showToast("Error posting media. Removing login session. Please try again."),window.location.href="/",Error("Network response was not ok")}catch(s){return console.error("Error posting tweet:",s),localStorage.clear(),sessionStorage.clear(),showToast("Error posting media. Removing login session. Please try again."),window.location.href="/",{error:s.message}}}async function checkToken(e){let t=new URLSearchParams;t.append("token",e);let o=t.toString();console.log("Checking Token:",e);let r=`${relayedEndpoint}/twitter/user_info?${o}`;await fetch(r).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(t=>(console.log(t),t.username&&t.profile_image_url)?(localStorage.setItem("twitter_id",t.id),localStorage.setItem("twitter_username",t.username),localStorage.setItem("twitter_pic",t.profile_image_url),console.log("Token Verified: ",e),sessionStorage.setItem("isLoggedIn","true"),!0):(sessionStorage.setItem("isLoggedIn","false"),null)).catch(e=>{console.error("Error fetching data:",e)})}async function revokeAccessToken(e){let t=new URLSearchParams;t.append("token",e);let o=t.toString(),r=`${relayedEndpoint}/twitter/revoke_token?${o}`;await fetch(r).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(e=>{e&&!0===e.revoked&&console.log("Revoked Token Access:",e)}).catch(e=>(console.error("Error fetching data:",e),null))}async function tryLogin(){let e=localStorage.getItem("twitter_username"),t=localStorage.getItem("twitter_pic");if(e&&t){sessionStorage.setItem("isLoggedIn","true");var o=document.getElementById("login-button");if(o){console.error("Login button found");var r=document.createElement("a");r.href="#",r.innerHTML='<img src="'+t+'" alt="Twitter Profile Picture" class="twitter-profile-pic">',o.parentNode.replaceChild(r,o),r.querySelector(".twitter-profile-pic").addEventListener("click",function(e){e.preventDefault();var t=document.getElementById("logout-dropdown");t.style.display="block"===t.style.display?"none":"block"}),console.error("Login success")}else console.error("Login button element not found in the DOM.")}}async function initiateLogout(){let e=localStorage.getItem("twitter_token");localStorage.clear(),sessionStorage.clear(),await revokeAccessToken(e),showToast("Logged out successfully"),window.location.href="/"}async function constructAuthURL(e){if("post"===e&&"true"===sessionStorage.getItem("isLoggedIn"))await postSequence();else try{let t=await fetch(relayedEndpoint+"/twitter/code_auth");if(!t.ok)throw Error("Network response was not ok");let o=await t.json(),r=o.link,n=new Date().toString();sessionStorage.setItem("dateTime",n),sessionStorage.setItem("twitter_state",e+o.state),sessionStorage.setItem("twitter_code_challenge",o.code_challenge),sessionStorage.setItem("twitter_code_verifier",o.code_verifier),console.log(r),window.location.href=r}catch(a){showToast("Failed to construct OAuth2.0"),console.error("Error fetching data:",a)}}function showToast(e){var t=document.createElement("div");t.classList.add("toast"),t.innerHTML=`
    <span class="toast-message">${e}</span>
    <span class="toast-close">&times;</span>
  `;var o=document.querySelector(".toast-container");o.appendChild(t),setTimeout(function(){o.contains(t)&&o.removeChild(t)},5e3),t.querySelector(".toast-close").addEventListener("click",function(){o.contains(t)&&o.removeChild(t)})}async function initHSButton(){var e,t=document.querySelectorAll("#share-score-button");for(let o of t){if("0"===document.querySelector("#share-score").innerText.trim())o.disabled=!0,o.style.opacity="0.5",o.style.cursor="not-allowed";else try{await fetchHighestScore(),o.disabled=!1,o.style.opacity="1",o.style.cursor="pointer"}catch(r){console.error("Error fetching highest score:",r)}}}async function fetchHighestScore(){try{let e=await fetch(relayedEndpoint+"/players/highscores"),t=await e.text(),o=JSON.parse(t);if(0===o.length)return 0;return console.log(o[0][1]),o[0][2]}catch(r){return console.error("Error fetching highest score:",r),null}}async function accountPoints(e){let t=new URLSearchParams;t.append("ip",sessionStorage.getItem("twitter_user_ip")),t.append("score",e),localStorage.getItem("twitter_username")&&t.append("twitter",localStorage.getItem("twitter_username"));let o=t.toString(),r=`${relayedEndpoint}/players/add?${o}`;await fetch(r).then(e=>{if(!e.ok)throw Error("Network response was not ok");return e.json()}).then(t=>{sessionStorage.setItem("twitter_score",e)}).catch(e=>{console.error("Error fetching data:",e)})}async function logScore(){var e=document.querySelector("#gamedisplay > div.score"),t=document.querySelectorAll("#share-score");if(e){var o=e.innerText.split(":")[1].trim();t.forEach(function(e){e.innerText=o}),await initHSButton(),sessionStorage.setItem("twitter_score",o),await populateHS()}else console.log("Score element not found.")}async function getEndpoint(){var e=window.location.pathname;if("/callback"===e){let t=new URLSearchParams(window.location.search),o=t.get("state"),r=sessionStorage.getItem("twitter_state"),n=t.get("code");console.log("Twitter State:",o),console.log("Local Twitter State:",r),console.log("Twitter Code:",n),r.includes(o)?(await newTwitterToken(n),await tryLogin(),r.includes("post")&&(console.log("Ready to Post"),await postSequence())):showToast("Error. Invalid State.")}else"/version"===e&&showToast("Game Version:"+gameVersion),sessionStorage.removeItem("twitter_score")}async function postSequence(){var e=localStorage.getItem("twitter_username"),t=localStorage.getItem("twitter_pic"),o=sessionStorage.getItem("twitter_score");await obtainRefreshToken(),await uploadMedia(e,t,o),showToast("Posting... "),await postMedia("I JUST SCORED "+o+" POINTS on @Base_Invader! BaseInvaders is beyond BASED. Will this net me some $BINV tokens? #BaseInvaders",sessionStorage.getItem("twitter_media_id"),localStorage.getItem("twitter_token"))}async function routineProcedure(){sessionStorage.setItem("baseinvader_version",gameVersion),await getIPAddress(),await obtainRefreshToken(),await tryLogin(),await initHSButton(),await populateHS(),await getEndpoint()}function updateLinks(e,t){let o=document.getElementById("gitbook-link"),r=document.getElementById("uniswap-link"),n=document.getElementById("uniswap-social-link");o?o.href=e:console.log("No Gitbook"),r?r.href=t:console.log("No UniSwap"),n?n.href=t:console.log("No UniSwap Social")}var observerConfig={childList:!0,subtree:!0},callback=function(e,t){for(var o of e)if("childList"===o.type&&o.addedNodes&&o.addedNodes.length)for(var r=0;r<o.addedNodes.length;r++){var n=o.addedNodes[r];if("BIG"===n.nodeName&&"Game Over"===n.textContent.trim()){logScore();return}}},observer=new MutationObserver(callback);document.addEventListener("DOMContentLoaded",function(){observer.observe(document.body,observerConfig)}),routineProcedure();
